<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>채팅방</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    #chatBox { height: 1000px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: white; }
    .msg { margin: 5px 0; }
    .me { text-align: right; color: blue; }
    .other { text-align: left; color: green; }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <base href="http://localhost:3000">
</head>
<body>

  <h2 id="roomTitle">채팅방</h2>
  <div class="rounded-bottom-0 rounded-top-2 border-0 " id="chatBox" style="background-color: rgba(0, 0, 0, 0.233);"></div>
  <div class="input-group ">
    <input class="form-control rounded-top-0 border-0" type="text" id="msgInput" placeholder="메시지를 입력하세요" style="background-color: rgba(0, 0, 0, 0.425);">
    <button class="btn rounded-top-0" onclick="sendMessage()" style="background-color: rgba(0, 8, 244, 0.52);"><img src="send.svg" alt="전송"></button>
  </div>

  <script>
    let urlParams = new URLSearchParams(window.location.search);
    let roomName = urlParams.get('room');
    let userName = prompt("이름을 입력하세요") || "익명";

    if (!roomName) {
      alert("잘못된 접근입니다.");
      location.href = "index.html";
    }

    document.getElementById("roomTitle").textContent = `채팅방: ${roomName}`;

    // 채팅 데이터 키 = room 이름 기준
    function getMessages() {
      let data = localStorage.getItem("chat_" + roomName);
      return data ? JSON.parse(data) : [];
    }

    function saveMessages(messages) {
      localStorage.setItem("chat_" + roomName, JSON.stringify(messages));
    }

    function renderMessages() {
      let messages = getMessages();
      let chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      messages.forEach(m => {
        let msgtoast = document.createElement("div");
        msgDiv.className = "msg " + (m.user === userName ? "me" : "other");
        msgDiv.textContent = m.user + ": " + m.message;
        chatBox.appendChild(msgDiv);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMessage() {
      let input = document.getElementById("msgInput");
      let text = input.value.trim();
      if (!text) return;

      let newMsg = { user: userName, message: text };
      input.value = "";

      setTimeout(() => {
        let messages = getMessages();
        messages.push(newMsg);
        saveMessages(messages);
        renderMessages();
      }, 200);
    }

    window.addEventListener("storage", e => {
      if (e.key === "chat_" + roomName) renderMessages();
    });

    renderMessages();
  </script>

</body>
</html>
